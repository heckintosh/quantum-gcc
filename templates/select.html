<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Select Chat Partner</title>
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>
<body>
<div class="container mt-5">
  <h2>Welcome, {{ username }}!</h2>
  <p>Select a chat partner to start a private conversation:</p>
  <form action="{{ url_for('set_target') }}" method="POST">
    <ul id="activeUserList" class="list-group mb-3">
      <!-- Active users will be populated here -->
    </ul>
    <!-- Hidden input to store the selected partner -->
    <input type="hidden" id="selectedTarget" name="target" value="">
  </form>
</div>
<!-- Socket.IO JavaScript (CDN) -->
<script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
<script>
  const socket = io();
  const activeUserList = document.getElementById('activeUserList');
  const selectedTargetInput = document.getElementById('selectedTarget');
  const username = "{{ username }}";

  socket.on('connect', function() {
    console.log('Connected to Socket.IO');
  });

  socket.on('active_users', function(users) {
    activeUserList.innerHTML = '';
    users.forEach(function(user) {
      if (user === username) return; // exclude self
      const li = document.createElement('li');
      li.textContent = user;
      li.dataset.username = user; // store username in data attribute
      li.className = 'list-group-item list-group-item-action';
      li.style.cursor = 'pointer';
      li.addEventListener('click', function() {
        selectedTargetInput.value = user;
        li.parentElement.parentElement.submit();
      });
      activeUserList.appendChild(li);
    });
  });

  // When a chat request is received, add a tick next to the requesting user's name.
  socket.on('chat_request', function(data) {
    const liElements = activeUserList.getElementsByTagName('li');
    for (let li of liElements) {
         if (li.dataset.username === data.from) {
             if (!li.querySelector('.tick-icon')) {
                 const tick = document.createElement('span');
                 tick.className = 'tick-icon ml-2';
                 tick.textContent = 'âœ“';
                 li.appendChild(tick);
             }
         }
    }
  });
</script>
</body>
</html>
